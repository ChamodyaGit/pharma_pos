<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application | Items</title>
    <link rel="icon" href="../../images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="../../styles/common.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        #prescriptionCanvas,
        #signatureCanvas {
            touch-action: none;
            display: block;
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            background: #fff;
        }
    </style>
</head>

<body class="h-dvh flex flex-col">
    <!--Nav-->
    <div class="nav bg-basic w-full py-6 flex justify-between items-center max-lg:justify-center max-lg:flex-col">
        <span class="flex items-center gap-3 ml-20 max-lg:ml-0 max-sm:scale-75">
            <button onclick="history.go ( -1);"
                class="rounded-full w-[50px] text-basic aspect-square bg-white flex justify-center items-center hover:scale-90 transition-all">
                <i class="bi bi-chevron-left scale-[1.5]"></i>
            </button>
            <button onclick="window.location.href = '../../main-panel/';"
                class="p-2 text-basic rounded-lg bg-white flex gap-3 justify-center items-center hover:scale-90 transition-all">
                <i class="bi bi-house scale-[1.2]"></i>
                Go to Main Panel
            </button>
        </span>
        <span class="flex items-center gap-3 mr-20 max-lg:mr-0 max-sm:scale-75">
            <!--Logged User-->
            <h3 class="text-2xl max-md:text-sm text-white">Create a Prescription</h3>
            <!--log out btn-->
            <button onclick="window.location.href = '../../';"
                class="rounded-full w-[50px] text-basic aspect-square bg-white flex justify-center items-center hover:scale-90 transition-all">
                <i class="bi bi-box-arrow-left scale-[1.5]"></i>
            </button>
        </span>
    </div>
    <div class="flex-grow flex flex-col">
        <!--breadcrumbs-->
        <div class="px-12 max-sm:px-6 pt-5">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
                    <li class="inline-flex items-center">
                        <p class="inline-flex items-center text-sm font-medium text-gray-700">
                            <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z" />
                            </svg>
                            Main Panel
                        </p>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m1 9 4-4-4-4" />
                            </svg>
                            <p class="ms-1 text-sm font-medium text-gray-700 md:ms-2">Create Prescription</p>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>
        <!--main panel-->
        <div class="p-6">
            <div class="flex flex-col border-2 h-full rounded-lg p-6">
                <!-- Doctor Title -->
                <div class="text-center mb-4 hidden">
                    <h2 id="doctorName">Dr. John Doe</h2>
                    <p class="text-muted" id="doctorDetails">MBBS, MD - General Physician</p>
                </div>
                <label for="mfd" class="block mb-2 text-sm font-medium text-black">Select Patient</label>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <!-- Patient Select -->
                    <div class="flex-1">
                        <select id="patientSelect"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 w-full">
                            <option selected disabled>Select a patient</option>
                            <option>Shadow</option>
                            <option>Blacky</option>
                            <option>Seeba</option>
                        </select>
                    </div>
                
                    <!-- Add Patient Button -->
                    <div class="flex items-end">
                        <button
                            class="py-2.5 px-6 bg-basic text-white rounded-lg"
                            data-bs-toggle="modal" data-bs-target="#addPatientModal">
                            <i class="bi bi-plus-lg"></i>
                            <span>Add Patient</span>
                        </button>
                    </div>
                </div>

                <!-- Prescription Area (Canvas) -->
                <div class="mb-3">
                    <label class="block mb-2 text-sm font-medium text-black mt-2">Prescription (Draw / Write)</label>
                    <canvas id="prescriptionCanvas"></canvas>
                </div>
                <div class="mb-4">
                    <button class="btn btn-danger" onclick="clearPrescription()">üóëÔ∏è Clear</button>
                </div>

                <!-- Signature Button -->
                <div class="text-end">
                    <button class="py-2.5 px-6 bg-basic text-white rounded-lg" onclick="savePrescription()">üíæ Save</button>
                </div>
            </div>
        </div>

        <!-- Add Patient Modal -->
        <div class="modal fade" id="addPatientModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Patient</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">Patient Name</label>
                                <input type="text" class="form-control" placeholder="Enter patient name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-control" placeholder="Enter age">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Gender</label>
                                <select class="form-select">
                                    <option>Male</option>
                                    <option>Female</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary">Save Patient</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signature Modal -->
        <div class="modal fade" id="signatureModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Doctor Signature</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <canvas id="signatureCanvas"></canvas>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-dark" onclick="setSignatureMode('black')">‚úèÔ∏è Draw</button>
                        <button class="btn btn-outline-secondary" onclick="setSignatureMode('white')">ü©π Erase</button>
                        <button class="btn btn-danger" onclick="clearSignature()">üóëÔ∏è Clear</button>
                        <button class="btn btn-primary" onclick="saveSignature()">üíæ Save</button>
                    </div>
                </div>
            </div>
        </div>

        <footer
            class="h-[80px] bg-basic max-md:text-sm max-sm:text-xs max-md:flex-col text-center w-full flex items-center text-white justify-center gap-3">
            <p>2025 ¬© All Rights Reserved | Application | Powered by Silicon Radon Networks (Pvt) Ltd</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ---- Prescription Canvas ----
        const prescriptionCanvas = document.getElementById('prescriptionCanvas');
        const prescriptionCtx = prescriptionCanvas.getContext('2d');
        let isDrawingPrescription = false;
        let prescriptionColor = 'black';
        let prescriptionWidth = 2;

        function initPrescriptionCanvas() {
            prescriptionCanvas.width = prescriptionCanvas.offsetWidth;
            prescriptionCanvas.height = 300;
            prescriptionCtx.strokeStyle = prescriptionColor;
            prescriptionCtx.lineWidth = prescriptionWidth;
            prescriptionCtx.lineCap = 'round';
        }

        function getPrescriptionPos(e) {
            const rect = prescriptionCanvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function startPrescription(e) {
            isDrawingPrescription = true;
            const pos = getPrescriptionPos(e);
            prescriptionCtx.beginPath();
            prescriptionCtx.moveTo(pos.x, pos.y);
            drawPrescription(e);
        }

        function drawPrescription(e) {
            if (!isDrawingPrescription) return;
            const pos = getPrescriptionPos(e);
            prescriptionCtx.lineTo(pos.x, pos.y);
            prescriptionCtx.stroke();
            prescriptionCtx.beginPath();
            prescriptionCtx.moveTo(pos.x, pos.y);
        }

        function stopPrescription() { isDrawingPrescription = false; }

        function clearPrescription() { prescriptionCtx.clearRect(0, 0, prescriptionCanvas.width, prescriptionCanvas.height); }

        prescriptionCanvas.addEventListener('mousedown', startPrescription);
        prescriptionCanvas.addEventListener('mousemove', drawPrescription);
        prescriptionCanvas.addEventListener('mouseup', stopPrescription);
        prescriptionCanvas.addEventListener('mouseout', stopPrescription);

        prescriptionCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPrescription(e.touches[0]); });
        prescriptionCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawPrescription(e.touches[0]); });
        prescriptionCanvas.addEventListener('touchend', stopPrescription);

        // ---- Signature Canvas ----
        const signatureCanvas = document.getElementById('signatureCanvas');
        const signatureCtx = signatureCanvas.getContext('2d');
        let isDrawingSignature = false;
        let signatureColor = 'black';
        let signatureWidth = 2;

        function initSignatureCanvas() {
            signatureCanvas.width = signatureCanvas.offsetWidth;
            signatureCanvas.height = 300;
            signatureCtx.strokeStyle = signatureColor;
            signatureCtx.lineWidth = signatureWidth;
            signatureCtx.lineCap = 'round';
        }

        function getSignaturePos(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function startSignature(e) {
            isDrawingSignature = true;
            const pos = getSignaturePos(e);
            signatureCtx.beginPath();
            signatureCtx.moveTo(pos.x, pos.y);
            drawSignature(e);
        }

        function drawSignature(e) {
            if (!isDrawingSignature) return;
            const pos = getSignaturePos(e);
            signatureCtx.lineTo(pos.x, pos.y);
            signatureCtx.stroke();
            signatureCtx.beginPath();
            signatureCtx.moveTo(pos.x, pos.y);
        }

        function stopSignature() { isDrawingSignature = false; }

        function setSignatureMode(color) {
            signatureColor = color;
            signatureWidth = color === 'black' ? 2 : 10;
            signatureCtx.strokeStyle = signatureColor;
            signatureCtx.lineWidth = signatureWidth;
        }

        function clearSignature() { signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height); }

        signatureCanvas.addEventListener('mousedown', startSignature);
        signatureCanvas.addEventListener('mousemove', drawSignature);
        signatureCanvas.addEventListener('mouseup', stopSignature);
        signatureCanvas.addEventListener('mouseout', stopSignature);

        signatureCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startSignature(e.touches[0]); });
        signatureCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawSignature(e.touches[0]); });
        signatureCanvas.addEventListener('touchend', stopSignature);

        // ---- SAVE FULL PDF ----
        async function savePrescription() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "pt", "a4");

            // Doctor Header
            doc.setFontSize(18);
            doc.text(document.getElementById("doctorName").innerText, 40, 50);
            doc.setFontSize(12);
            doc.text(document.getElementById("doctorDetails").innerText, 40, 70);

            // Patient Info
            const patient = document.getElementById("patientSelect").value || "Not Selected";
            doc.setFontSize(14);
            doc.text("Patient: " + patient, 40, 110);
            doc.text("Date: " + new Date().toLocaleDateString(), 400, 110);

            // Prescription Title
            doc.setFontSize(16);
            doc.text("Prescription", 40, 150);

            // Prescription Canvas
            const prescriptionImg = prescriptionCanvas.toDataURL("image/png", 1.0);
            doc.addImage(prescriptionImg, "PNG", 40, 170, 500, 200);

            // Signature Title
            doc.setFontSize(14);
            doc.text("Doctor Signature:", 40, 400);

            // Signature Canvas
            const signatureImg = signatureCanvas.toDataURL("image/png", 1.0);
            doc.addImage(signatureImg, "PNG", 180, 370, 200, 100);

            // Save File
            doc.save("prescription-" + Date.now() + ".pdf");

            document.getElementById("patientSelect").value = "Select a patient";
            clearPrescription();   // üëà clears prescription drawing
            clearSignature();
        }

        window.onload = initPrescriptionCanvas;
    </script>

</body>
<script src="../../scripts/common.js"></script>

</html>